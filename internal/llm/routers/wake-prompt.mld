/import { @agent, @prompt, @agents, @in_thread } from @payload

/exe @haiku(prompt) = @prompt | cmd { claude -p --model haiku }

/exe @assess(agt, prompt, agents, thread) = [
  let @agent_status = @agents | map(a => `- @${a.name}: ${a.presence}${a.status ? " (" + a.status + ")" : ""}, idle ${a.idle_seconds}s`) | join("\n")
  let @scope = @thread ? `Scoped to thread: ${thread}` : "Watching all activity"
  let @full_prompt = `You're deciding whether to wake an agent based on periodic evaluation.

Agent to wake: @{{agt}}
Evaluation criteria: {{prompt}}
{{scope}}

Current agent statuses:
{{agent_status}}

Based on the criteria and current statuses, should @{{agt}} be woken up?

Consider:
- Does the current state match the wake criteria?
- Are the conditions described in the prompt being met?
- Is this an actionable situation requiring the agent's attention?

Return JSON: {"shouldWake": true/false, "reason": "brief explanation", "confidence": 0.0-1.0}`
  let @result = @haiku(@full_prompt) | @json.llm
  => {
    shouldWake: @result.shouldWake,
    reason: @result.reason,
    confidence: @result.confidence
  }
]

/show @assess(@agent, @prompt, @agents, @in_thread)

/export { @assess }
