---
id: f-82a4
status: closed
deps: [f-2312]
links: []
created: 2026-01-24T05:02:48Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase1]
---
# Phase 1: Migration command (fray migrate --multi-machine)

Implement the migration command to convert v1 projects to multi-machine mode.

**Context**: Read docs/MULTI-MACHINE-SYNC-PLAN.md section 1.7 and SPEC Migration section.

**Files to modify**: internal/command/migrate.go (extend existing)

**Command**: fray migrate --multi-machine

**Idempotency guard**: If shared/.v2 exists or any *.v1-migrated files exist, exit with 'already migrated'.

**Steps**:
1. Prompt for machine ID (or derive from hostname)
2. Create shared/machines/{id}/ and local/
3. Copy messages.jsonl, threads.jsonl, questions.jsonl to shared/
4. Split agents.jsonl:
   - ghost_cursor, faves, roles → shared/machines/{id}/agent-state.jsonl
   - agent, sessions, presence → local/runtime.jsonl
5. Write machine-id file (JSON with id, seq: 0, created_at)
6. **Create shared/.v2 sentinel (COMMIT POINT)**
7. Rename legacy files: *.jsonl → *.jsonl.v1-migrated
8. Update fray-config.json: storage_version: 2
9. Rebuild database

**Rollback**:
- If failure before step 6: remove shared/ and local/ directories
- If failure after step 6: migration is committed, manual cleanup needed

**Tests required**:
- Test migration creates correct directory structure
- Test files are copied/split correctly
- Test idempotency (second run exits cleanly)
- Test rollback on failure before commit point

## Acceptance Criteria

- Migration command implemented
- Idempotency guard works
- Rollback on pre-commit failure works
- Directory structure matches spec
- Unit/integration tests pass
- go test ./... passes
- Changes committed

