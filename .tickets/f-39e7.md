---
id: f-39e7
status: closed
deps: [f-82a4]
links: []
created: 2026-01-24T05:05:25Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase2]
---
# Phase 2: Legacy write blocking

Implement guards to prevent legacy binaries from writing to migrated projects.

**Context**: Read docs/MULTI-MACHINE-SYNC-SPEC.md Version Gate section and PLAN section 2.7.

**Files to modify**: 
- internal/db/jsonl_append.go (write path checks)
- internal/db/open.go (startup preflight)

**Guards**:

1. **Startup preflight**: If both .fray/messages.jsonl AND shared/.v2 exist, fail with error explaining conflict.

2. **Write path check**: All append functions check storage_version before writing:
```go
func AppendMessage(projectPath string, msg Message) error {
    if GetStorageVersion(projectPath) >= 2 {
        return appendToSharedMachine(projectPath, "messages.jsonl", msg)
    }
    return appendToLegacy(projectPath, "messages.jsonl", msg)
}
```

3. **Upgrade prompt**: If storage_version > 1 and we're about to write to legacy path, refuse with error and upgrade instructions.

**Note**: Migration already renames legacy files to *.v1-migrated, so this is defense-in-depth.

**Tests required**:
- Test startup fails if both legacy and sentinel exist
- Test write to legacy path fails in v2 mode
- Test write to shared path works in v2 mode
- Test legacy mode still works in v1

## Acceptance Criteria

- Startup preflight check implemented
- Write path checks for storage_version
- Helpful error messages with upgrade instructions
- Unit tests pass
- go test ./... passes
- Changes committed

