---
id: f-a390
status: closed
deps: [f-79de, f-f69d]
links: []
created: 2026-01-24T05:00:52Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase1]
---
# Phase 1: Update read functions for multi-machine merge

Update all Read* functions to merge data from all machines in multi-machine mode.

**Context**: Read docs/MULTI-MACHINE-SYNC-PLAN.md section 1.2.

**Files to modify**: internal/db/jsonl_read.go (or wherever Read* functions live)

**Pattern for each Read* function**:
```go
func ReadMessages(projectPath string) ([]MessageJSONLRecord, error) {
    if IsMultiMachineMode(projectPath) {
        return readMessagesMerged(projectPath)  // merge from all machines
    }
    return readMessagesLegacy(projectPath)  // existing code
}
```

**Merge logic**:
- Read from all shared/machines/*/messages.jsonl (etc.)
- Sort by (timestamp, machineID, seq) for deterministic order
- Track deletions (tombstones) - see SPEC section on sticky tombstones

**Functions to update**:
- ReadMessages
- ReadThreads  
- ReadQuestions
- ReadAgentState (new, for agent-state.jsonl)

**Local-only data**: ReadAgents should read from local/runtime.jsonl only (no merge).

**Tests required**:
- Test merge ordering is deterministic
- Test data from multiple machines is combined
- Test legacy mode still works (fallback)

## Acceptance Criteria

- All Read* functions updated with multi-machine branch
- Merge logic sorts by timestamp/machine/seq
- Legacy fallback works
- Unit tests pass
- go test ./... passes
- Changes committed

