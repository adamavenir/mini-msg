---
id: f-203b
status: closed
deps: [f-2312]
links: []
created: 2026-01-24T05:04:56Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase2]
---
# Phase 2: GUID collision detection and CLI

Implement GUID collision detection during rebuild with CLI to view collisions.

**Context**: Read docs/MULTI-MACHINE-SYNC-SPEC.md GUID collisions section and PLAN sections 2.5-2.6.

**Files to modify/create**: 
- internal/db/jsonl_rebuild.go (detection)
- internal/command/collisions.go (new CLI)

**Detection during rebuild**:
- Track seen GUIDs per machine in merge function
- On collision: Log warning, keep both (last-write-wins for display)
- Store collisions in local/collisions.json for CLI access

**NO auto-remediation**: Too complex, risk of breaking references.

**Collision storage** (local/collisions.json):
```json
[
  {"guid": "msg-abc", "machines": ["laptop", "server"], "detected_at": 1234567890, "type": "message"}
]
```

**CLI commands**:
```bash
fray collisions              # List detected GUID collisions
fray collisions --clear      # Clear collision log after manual review
```

**Output format**: GUID, machines involved, timestamps, affected content preview.

**Tests required**:
- Test collision is detected when same GUID from different machines
- Test collision is logged and stored
- Test CLI lists collisions
- Test --clear removes collision log

## Acceptance Criteria

- Collision detection in rebuild
- Collisions stored in local/collisions.json
- CLI to list and clear collisions
- Unit tests pass
- go test ./... passes
- Changes committed

