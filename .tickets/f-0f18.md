---
id: f-0f18
status: closed
deps: [f-366d]
links: []
created: 2026-01-24T05:03:11Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase2]
---
# Phase 2: Atomic append with flock and fsync

Implement atomic append for JSONL files with proper locking and durability.

**Context**: Read docs/MULTI-MACHINE-SYNC-SPEC.md File Integrity section and PLAN section 2.1.

**Files to modify**: internal/db/jsonl_append.go

**Implementation**:
```go
func atomicAppend(path string, data []byte) error {
    f, err := os.OpenFile(path, os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0644)
    if err \!= nil { return err }
    defer f.Close()

    // Exclusive lock for the append
    if err := syscall.Flock(int(f.Fd()), syscall.LOCK_EX); err \!= nil {
        return err
    }
    defer syscall.Flock(int(f.Fd()), syscall.LOCK_UN)

    // Write data + newline
    if _, err := f.Write(append(data, '\n')); err \!= nil {
        return err
    }

    // Ensure durability
    return f.Sync()
}
```

**Update all Append* functions** to use atomicAppend instead of direct file writes.

**Tests required**:
- Test concurrent appends are serialized
- Test data is durable (fsync)
- Test newline is always appended

## Acceptance Criteria

- atomicAppend function implemented
- All Append* functions use atomicAppend
- Concurrent write test passes
- go test ./... passes
- Changes committed

