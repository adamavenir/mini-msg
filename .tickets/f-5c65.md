---
id: f-5c65
status: closed
deps: [f-a390]
links: []
created: 2026-01-24T05:03:34Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase2]
---
# Phase 2: Truncated line recovery

Implement recovery logic for truncated/partial JSONL lines.

**Context**: Read docs/MULTI-MACHINE-SYNC-SPEC.md File Integrity section.

**Files to modify**: internal/db/jsonl_read.go (or JSONL parsing code)

**Recovery behavior**:
- Each line must be valid JSON ending in newline
- If final line has no newline (truncated): discard with warning log
- If line is invalid JSON: skip with warning, continue processing

**Implementation in read loop**:
```go
for scanner.Scan() {
    line := scanner.Text()
    var record Record
    if err := json.Unmarshal([]byte(line), &record); err != nil {
        log.Warnf("skipping invalid JSON at line %d: %v", lineNum, err)
        continue
    }
    records = append(records, record)
}
// Check for partial final line (scanner doesn't include it if no newline)
```

**Tests required**:
- Test valid JSONL parses correctly
- Test truncated final line (no newline) is skipped with warning
- Test invalid JSON line is skipped, rest of file processed
- Test empty file works

## Acceptance Criteria

- Truncated line recovery implemented
- Invalid JSON lines skipped with warning
- Rest of file still processed
- Unit tests pass
- go test ./... passes
- Changes committed

