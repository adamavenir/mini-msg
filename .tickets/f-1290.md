---
id: f-1290
status: closed
deps: [f-0f18]
links: []
created: 2026-01-24T05:03:58Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase2]
---
# Phase 2: Per-file SHA256 checksums

Implement per-file SHA256 checksums for interim integrity verification.

**Context**: Read docs/MULTI-MACHINE-SYNC-SPEC.md Interim Integrity section and PLAN section 2.4.

**Files to create/modify**: 
- internal/db/checksums.go (new)
- internal/db/jsonl_append.go (integrate)

**Checksum file**: shared/checksums.json
```json
{
  "laptop": {
    "messages.jsonl": {"sha256": "abc123...", "lines": 1234, "mtime": 1234567890},
    "threads.jsonl": {"sha256": "def456...", "lines": 56, "mtime": 1234567890}
  }
}
```

**Write ordering with flock**:
1. Append event to data file (flock on data file)
2. Update checksums.json (separate flock on checksums.json)

**Mismatch handling during rebuild**:
- Compare data file mtime vs checksum entry mtime
- Data newer than checksum: recalculate silently (write race)
- Checksum newer or same but hash differs: warn, recalculate

**Tests required**:
- Test checksum is updated on append
- Test concurrent checksum updates are serialized
- Test mismatch detection with mtime comparison
- Test rebuild handles missing/stale checksums gracefully

## Acceptance Criteria

- Checksum file created and updated on writes
- Flock protection for concurrent updates
- mtime comparison for mismatch handling
- Unit tests pass
- go test ./... passes
- Changes committed

