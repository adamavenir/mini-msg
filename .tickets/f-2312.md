---
id: f-2312
status: closed
deps: [f-a390, f-366d]
links: []
created: 2026-01-24T05:02:21Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase1]
---
# Phase 1: Update rebuild logic and mtime check for multi-machine

Update RebuildDatabaseFromJSONL and mtime checking to work with multi-machine storage.

**Context**: Read docs/MULTI-MACHINE-SYNC-PLAN.md sections 1.5 and 1.6 (now 1.5-1.6 after reordering).

**Files to modify**: 
- internal/db/jsonl_rebuild.go
- internal/db/open.go

**Rebuild changes**:
```go
func RebuildDatabaseFromJSONL(...) {
    if GetStorageVersion(projectPath) >= 2 {
        return rebuildMultiMachine(...)  // Use merged Read* functions
    }
    return rebuildLegacy(...)  // Existing code
}
```

**Multi-machine rebuild**:
- Use Read* functions (which now handle merge)
- Apply agent descriptors from remote machines (for agent discovery)
- Overlay local invoke config from runtime.jsonl

**mtime check changes**:
Check all machine directories + local/runtime.jsonl for changes:
- shared/machines/*/messages.jsonl
- shared/machines/*/threads.jsonl
- shared/machines/*/questions.jsonl
- shared/machines/*/agent-state.jsonl
- local/runtime.jsonl

**Tests required**:
- Test rebuild works in multi-machine mode
- Test rebuild falls back to legacy mode
- Test mtime check detects changes in any machine directory

## Acceptance Criteria

- Rebuild branches on storage_version
- mtime check covers all machine directories
- Legacy mode still works
- Unit tests pass
- go test ./... passes
- Changes committed

