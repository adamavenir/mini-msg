---
id: f-366d
status: closed
deps: [f-79de, f-f69d]
links: []
created: 2026-01-24T05:01:14Z
type: task
priority: 1
assignee: Adam Avenir
parent: f-4001
tags: [multi-machine, phase1]
---
# Phase 1: Update write functions for multi-machine routing

Update all Append* functions to route writes to correct location in multi-machine mode.

**Context**: Read docs/MULTI-MACHINE-SYNC-PLAN.md section 1.3.

**Files to modify**: internal/db/jsonl_append.go (or wherever Append* functions live)

**Routing table**:
| Function | Target (multi-machine) |
|----------|------------------------|
| AppendMessage, AppendMessageUpdate, AppendReaction | shared/machines/{local}/messages.jsonl |
| AppendThread*, AppendMessagePin/Unpin | shared/machines/{local}/threads.jsonl |
| AppendQuestion* | shared/machines/{local}/questions.jsonl |
| AppendGhostCursor, AppendAgentFave, AppendRole* | shared/machines/{local}/agent-state.jsonl |
| AppendAgent, AppendSession*, AppendPresence*, AppendWake* | local/runtime.jsonl |

**Add fields to message records**:
- origin: machine ID that created this message
- seq: sequence number from GetNextSequence()

**Tests required**:
- Test messages go to shared/machines/{local}/messages.jsonl
- Test agent registration goes to local/runtime.jsonl
- Test origin and seq fields are added
- Test legacy mode still works

## Acceptance Criteria

- All Append* functions route to correct path
- origin and seq fields added to records
- Legacy fallback works  
- Unit tests pass
- go test ./... passes
- Changes committed

